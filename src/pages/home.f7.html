
<template>
  <div class="page" data-name="home">
  
    <!-- Scrollable page content-->
    <div class="page-content">
      <!--<div class="block-title margin-bottom-half margin-top-half">Home</div>-->
      
      <div class="navbar">
        <div class="navbar navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="title padding-half no-margin logoname">BizTrack</div>
        <div class="right">
          <div class="installApp display-none">
            <a href="#" class="link">
                <i class="icon f7-icons">plus_circle_fill</i>
                <div>Install This App</div>
              </a>
            </div>
        </div>
      </div>
    </div>

      <!--<div class="block block-strong margin-bottom-half no-margin-top">
        <p>Here is your blank Framework7 app. Let's see what we have here.</p>
      </div>-->
      <div class="parentWrap">
      
      <div class="no-margin-top margin-bottom-half" style="width:100%">
        <div class="row padding-horizontal-half">
          <div class="col">
            <div class="text-align-center compName padding-vertical-half no-margin-vertical display-flex align-items-center"></div>
            </div>
        </div>
          <div class="row padding-horizontal-half">
            <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                    <a href="/ingredient/" class="item-content item-link">
                      <div class="item-inner">
                        <div class="item-title myPurple">
                          <i class="icon f7-icons text-color-blue1">layers_alt</i>
                          <div>Raw Materials</div>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                  <a href="/products/" class="item-content item-link">
                    <div class="item-inner">
                      <div class="item-title myPurple">
                        <i class="icon f7-icons text-color-blue1">cube_box</i>
                        <div>Products</div>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="row padding-horizontal-half">
            <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                    <a href="/sales/" class="item-content item-link">
                      <div class="item-inner">
                        <div class="item-title myPurple">
                          <i class="icon f7-icons text-color-blue1">tag</i>
                          <div>Sales / Estimates</div>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                    <a href="/expenses/" class="item-content item-link">
                    <div class="item-inner">
                      <div class="item-title myPurple">
                        <i class="icon f7-icons text-color-blue1">purchased</i>
                        <div>Expenses</div>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="row padding-horizontal-half">
            <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                    <a href="/clients/" class="item-content item-link">
                      <div class="item-inner">
                        <div class="item-title myPurple">
                          <i class="icon f7-icons text-color-blue1">person_2</i>
                          <div>Clients</div>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card myCard">
                  <div class="card-content text-align-center padding-vertical">
                    <a href="/reports/" class="item-content item-link">
                    <div class="item-inner">
                      <div class="item-title myPurple">
                        <i class="icon f7-icons text-color-blue1">chart_bar</i>
                        <div>Reports</div>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="row padding-horizontal-half">
            <div class="col">
              <div class="card myCard">
                <div class="card-content text-align-center padding-vertical">
                  <a href="/sync/" class="item-content item-link">
                  <div class="item-inner">
                    <div class="item-title myPurple">
                      <i class="icon f7-icons text-color-blue1">cloud_upload</i>
                      <div>Sync</div>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>

            <div class="col">
              <div class="card myCard">
                <div class="card-content text-align-center padding-vertical">
                  <a href="/settings/" class="item-content item-link">
                  <div class="item-inner">
                    <div class="item-title myPurple">
                      <i class="icon f7-icons text-color-blue1">gear_alt</i>
                      <div>Settings</div>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
          </div>
      </div>
    </div>

     
    </div>
  </div>
</template>
<script>
//import Dexie from 'dexie';
import {fakeAlert} from '../js/myscript.js';
var dbSettings = null, dbSettingsImages = null;
var deferredPrompt;
var displayMode;
export default {
  data() {
        return {
          settingsID: 'settings',
          settings: null,
          signature: null,
          logo: null
        };
      },
  methods: {
      openAlert: function (text) {
        var self = this;
        self.$app.dialog.alert(text);
        //alert(text);
      },
      test: function(){
        fakeAlert();
      },
      showToast: function(text, position, time = 2000){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: time,
                        }).open();
        },
        startPouch: function(){
          var self = this;
          //db = null;
          try{//id,name,unit_size,unit,cost_per_unit,status,created_date
            if(pdf != undefined){
              dbSettings = new PouchDB('settings.db', { adapter: 'cordova-sqlite' });
              dbSettingsImages = new PouchDB('settingsImages.db', { adapter: 'cordova-sqlite' });
                self.getData();
              }
          }catch(err){
            dbSettings = new PouchDB('settings.db');
            dbSettingsImages = new PouchDB('settingsImages.db');
              //self.syncDB();
              self.getData();
            }
        },
        syncDB: function(){
          var self = this;
          $.ajax({
              url: "_all_dbs", 
              type:"GET",
              "crossDomain": true,
              success: function(result){
                
              },
              error: function(err){
                
              }
          });
          
        },
        clearAllDB: function(){
          var self = this;
          self.$app.preloader.show();
          try{
              window.indexedDB.databases().then((r) => {
                for (var i = 0; i < r.length; i++) window.indexedDB.deleteDatabase(r[i].name);
            }).then(() => {
              self.$app.preloader.hide();
                self.showToast('All data cleared.', "center");
            }).catch((e) => {
              self.$app.preloader.show();
              self.showToast(e, "center");
            });
          }catch(err){
            self.$app.preloader.hide();
            self.showToast(err, "center");
          }
          
        },
        getData: function(){
          var self = this;
          var id = self.settingsID;
          dbSettings.get(id).then(function(doc) {
                var comName = doc.companyName;
                var curr = doc.currency;
                if(comName != "" & comName != null){
                  $(".compName").text(comName);
                  $(".compName").removeClass("display-none");
                }
                if(curr == undefined || curr == "" || curr == null){
                  self.showToast("Please visit Settings page to choose your currency and save company info!", "top", 3500);
                }
            }).catch(function(){
              self.showToast("Please visit Settings page to choose your currency and save company info!", "top", 3500);
            })

            dbSettingsImages.get('logoImage', {attachments: true}).then(function (blobOrBuffer) {

                    // handle result
                    self.$setState({
                      logo: blobOrBuffer
                    })
                    var attachments = blobOrBuffer._attachments.logoImage.data;
                    var type = blobOrBuffer._attachments.logoImage.content_type;

                    var imgPresent = $(".compName").find("img").length;
                    if(imgPresent == 0){
                      var img = "<img src='" + "data:"+ type + ";base64," + attachments + "' style='max-width:50px;margin-right:5px;'/>";
                      $(".compName").prepend(img);
                    }else{
                      var src = "data:"+ type + ";base64," + attachments;
                      $(".compName").find("img").attr("src", src);
                    }

                  }).catch(function (err) {
                  });
        },
      reloadPage: function(){
        var self = this;
        dbSettingsImages.get('logoImage', {attachments: true}).then(function (blobOrBuffer) {
                    // handle result
                    self.$setState({
                      logo: blobOrBuffer
                    })
                    var attachments = blobOrBuffer._attachments.logoImage.data;
                              var type = blobOrBuffer._attachments.logoImage.content_type;
                              var imgPresent = $(".compName").find("img").length;
                    if(imgPresent == 0){
                      var img = "<img src='" + "data:"+ type + ";base64," + attachments + "' style='max-width:50px;margin-right:5px;'/>";
                      $(".compName").prepend(img);
                    }else{
                      var src = "data:"+ type + ";base64," + attachments;
                      $(".compName").find("img").attr("src", src);
                    }
                  }).catch(function (err) {
                    
                  });
      },
      startDB: function(){
         //this.$app.methods.storage2();
          var self = this;
         var db = new Dexie("BizExpenseManagerDB");
          db.version(1).stores({
            ingredients: "++id,name,unit_size,unit,cost_per_unit,status,created_date",
            products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",
            sales: "++id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses: "++id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status",

            ingredients_history: "++id,ingID,name,unit_size,unit,cost_per_unit,status,created_date",
            products_history: "++id,prodID,name,cost,status,created_date",
            sales_history: "++id,salesID,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses_history: "++id,expID,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status"
          })
                
          //self.$app.dialog.alert("DB Created");
      }
    },
    on: {
      pageMounted: function(e, page) {
        var self = this;
        /*var comName = localStorage.getItem("companyName");
        var curr = localStorage.getItem("currency");
        if(curr == undefined){
          self.showToast("Please visit settings page to choose your currency and save company info!", "top", 3500);
        }*/
      },
      pageInit: function(e, page) {
        var self = this;
        self.startPouch();
        determineShowPWA();
      },
      pageAfterIn: function (event, page) {
          // do something after page gets into the view
          var self = this;
          
          //self.getData();
      }
    }
}

function determineShowPWA(){
  //console.log(displayMode);
  if(displayMode.indexOf("standalone") < 0 && displayMode != '' && deferredPrompt != undefined){
    showInstallPromotion();
  } 
}

window.addEventListener('DOMContentLoaded', () => {
  //console.log("DOM loaded");
  displayMode = '';
  if (navigator.standalone) {
    displayMode = 'standalone-ios';
  }
  if (window.matchMedia('(display-mode: standalone)').matches) {
    displayMode = 'standalone';
  }
  if(displayMode == ''){
    displayMode = 'browser tab';
  }
  // Log launch display mode to analytics
  //console.log('DISPLAY_MODE_LAUNCH:', displayMode);
});

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  //console.log("Before install called")
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Update UI notify the user they can install the PWA
  //console.log("beforeInstall", displayMode);
});

function showInstallPromotion(){
  $(".installApp").removeClass("display-none");
  $(".installApp a").on('click', (e) => {
  // Hide the app provided install promotion
    //hideMyInstallPromotion();
    // Show the install prompt
    deferredPrompt.prompt();
    // Wait for the user to respond to the prompt
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        hideMyInstallPromotion();
        //console.log('User accepted the install prompt');
      } else {
        //console.log('User dismissed the install prompt');
      }
    });
  });
}

function hideMyInstallPromotion(){
  $(".installApp").addClass("display-none");
}

window.addEventListener('appinstalled', (evt) => {
  // Log install to analytics
  console.log('INSTALL: Success');
});
</script>